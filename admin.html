<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNCAGED | Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0D0D0D;
            --bg-secondary: #1A1A1A;
            --bg-tertiary: #242424;
            --accent-gold: #F5A623;
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --text-muted: #666666;
            --border-color: #2A2A2A;
            --success: #28A745;
            --danger: #DC3545;
        }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(13,13,13,0.95); backdrop-filter: blur(10px); display: flex; align-items: center; padding: 0 30px; z-index: 1000; border-bottom: 1px solid var(--border-color); gap: 20px; }
        .logo { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 3px; background: linear-gradient(135deg, var(--accent-gold), #D4880F); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; }
        .admin-badge { background: var(--danger); color: #fff; font-size: 11px; padding: 4px 10px; border-radius: 4px; font-weight: 600; }
        .nav-tabs { display: flex; gap: 5px; margin-left: 40px; }
        .nav-tab { padding: 8px 16px; background: var(--bg-secondary); border: none; border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 13px; }
        .nav-tab:hover { background: var(--bg-tertiary); }
        .nav-tab.active { background: var(--accent-gold); color: #000; }
        .main-content { max-width: 1400px; margin: 0 auto; padding: 80px 30px 40px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-secondary); border-radius: 12px; padding: 20px; }
        .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .stat-label { color: var(--text-muted); font-size: 13px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 20px; font-weight: 600; }
        .search-input { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; color: var(--text-primary); font-size: 14px; width: 300px; }
        .data-table { width: 100%; background: var(--bg-secondary); border-radius: 12px; overflow: hidden; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background: var(--bg-tertiary); color: var(--text-secondary); font-size: 12px; text-transform: uppercase; }
        .data-table tr:last-child td { border-bottom: none; }
        .video-cell { display: flex; align-items: center; gap: 12px; }
        .video-thumb { width: 80px; height: 45px; background: var(--bg-tertiary); border-radius: 6px; overflow: hidden; }
        .video-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .user-cell { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-gold), #D4880F); display: flex; align-items: center; justify-content: center; font-weight: 700; color: #000; font-size: 12px; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; }
        .status-badge.active, .status-badge.public { background: rgba(40,167,69,0.2); color: var(--success); }
        .status-badge.banned, .status-badge.removed { background: rgba(220,53,69,0.2); color: var(--danger); }
        .status-badge.pending { background: rgba(255,193,7,0.2); color: #FFC107; }
        .action-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .action-btn.view { background: var(--bg-tertiary); color: var(--text-primary); }
        .action-btn.remove { background: rgba(220,53,69,0.2); color: var(--danger); }
        .action-btn.approve { background: rgba(40,167,69,0.2); color: var(--success); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
        .section { display: none; }
        .section.active { display: block; }
        @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } .nav-tabs { display: none; } }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">UNCAGED</a>
        <span class="admin-badge">ADMIN</span>
        <div class="nav-tabs">
            <button class="nav-tab active" data-section="overview">Overview</button>
            <button class="nav-tab" data-section="videos">Videos</button>
            <button class="nav-tab" data-section="users">Users</button>
            <button class="nav-tab" data-section="reports">Reports</button>
        </div>
    </header>

    <main class="main-content">
        <!-- Overview -->
        <div class="section active" id="section-overview">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="totalVideos">0</div><div class="stat-label">Total Videos</div></div>
                <div class="stat-card"><div class="stat-value" id="totalUsers">0</div><div class="stat-label">Total Users</div></div>
                <div class="stat-card"><div class="stat-value" id="totalViews">0</div><div class="stat-label">Total Views</div></div>
                <div class="stat-card"><div class="stat-value" id="pendingReports">0</div><div class="stat-label">Pending Reports</div></div>
            </div>
            <div class="section-header"><h2 class="section-title">Recent Videos</h2></div>
            <table class="data-table"><thead><tr><th>Video</th><th>Creator</th><th>Views</th><th>Status</th><th>Actions</th></tr></thead><tbody id="recentVideosBody"></tbody></table>
        </div>

        <!-- Videos -->
        <div class="section" id="section-videos">
            <div class="section-header"><h2 class="section-title">All Videos</h2><input type="text" class="search-input" placeholder="Search videos..." id="videoSearch"></div>
            <table class="data-table"><thead><tr><th>Video</th><th>Creator</th><th>Views</th><th>Status</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody id="allVideosBody"></tbody></table>
        </div>

        <!-- Users -->
        <div class="section" id="section-users">
            <div class="section-header"><h2 class="section-title">All Users</h2><input type="text" class="search-input" placeholder="Search users..." id="userSearch"></div>
            <table class="data-table"><thead><tr><th>User</th><th>Email</th><th>Videos</th><th>Joined</th><th>Status</th><th>Actions</th></tr></thead><tbody id="allUsersBody"></tbody></table>
        </div>

        <!-- Reports -->
        <div class="section" id="section-reports">
            <div class="section-header"><h2 class="section-title">Content Reports</h2></div>
            <table class="data-table"><thead><tr><th>Content</th><th>Reason</th><th>Reporter</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody id="reportsBody"></tbody></table>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDNPN3jptNzbR8vWy5hnVCuLoIBK2AW_HQ",
            authDomain: "uncaged-85b49.firebaseapp.com",
            projectId: "uncaged-85b49",
            storageBucket: "uncaged-85b49.firebasestorage.app",
            messagingSenderId: "957750920887",
            appId: "1:957750920887:web:9af4d847dad76c876d2f32"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allVideos = [], allUsers = [], allReports = [];

        function formatDate(ts) {
            if (!ts) return 'N/A';
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatNum(n) {
            if (n >= 1000000) return (n/1000000).toFixed(1)+'M';
            if (n >= 1000) return (n/1000).toFixed(1)+'K';
            return n.toString();
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'login.html'; return; }
            await loadData();
        });

        async function loadData() {
            const vSnap = await getDocs(collection(db, 'videos'));
            allVideos = []; vSnap.forEach(d => allVideos.push({ id: d.id, ...d.data() }));
            allVideos.sort((a,b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));

            const uSnap = await getDocs(collection(db, 'users'));
            allUsers = []; uSnap.forEach(d => allUsers.push({ id: d.id, ...d.data() }));

            try {
                const rSnap = await getDocs(collection(db, 'reports'));
                allReports = []; rSnap.forEach(d => allReports.push({ id: d.id, ...d.data() }));
            } catch(e) { allReports = []; }

            const totalViews = allVideos.reduce((s,v) => s + (v.views||0), 0);
            document.getElementById('totalVideos').textContent = allVideos.length;
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('totalViews').textContent = formatNum(totalViews);
            document.getElementById('pendingReports').textContent = allReports.filter(r => r.status === 'pending').length;

            renderVideos('recentVideosBody', allVideos.slice(0,5));
            renderVideos('allVideosBody', allVideos, true);
            renderUsers();
            renderReports();
        }

        function renderVideos(bodyId, videos, showDate = false) {
            const body = document.getElementById(bodyId);
            if (!videos.length) { body.innerHTML = '<tr><td colspan="6" class="empty-state">No videos</td></tr>'; return; }
            body.innerHTML = videos.map(v => {
                const thumb = v.thumbnail || `https://vz-fa698983-d99.b-cdn.net/${v.bunnyVideoId||v.id}/thumbnail.jpg`;
                return `<tr>
                    <td><div class="video-cell"><div class="video-thumb"><img src="${thumb}" onerror="this.style.display='none'"></div><span>${v.title||'Untitled'}</span></div></td>
                    <td>${v.creatorName||'Unknown'}</td>
                    <td>${formatNum(v.views||0)}</td>
                    <td><span class="status-badge ${v.visibility||'public'}">${v.visibility||'public'}</span></td>
                    ${showDate ? `<td>${formatDate(v.createdAt)}</td>` : ''}
                    <td><button class="action-btn view" onclick="window.open('watch.html?v=${v.id}')">View</button><button class="action-btn remove" onclick="removeVideo('${v.id}')">Remove</button></td>
                </tr>`;
            }).join('');
        }

        function renderUsers() {
            const body = document.getElementById('allUsersBody');
            if (!allUsers.length) { body.innerHTML = '<tr><td colspan="6" class="empty-state">No users</td></tr>'; return; }
            body.innerHTML = allUsers.map(u => {
                const name = u.displayName || u.username || 'User';
                const vCount = allVideos.filter(v => v.creatorId === u.id).length;
                const status = u.banned ? 'banned' : 'active';
                return `<tr>
                    <td><div class="user-cell"><div class="user-avatar">${name[0].toUpperCase()}</div><span>${name}</span></div></td>
                    <td>${u.email||'N/A'}</td>
                    <td>${vCount}</td>
                    <td>${formatDate(u.createdAt)}</td>
                    <td><span class="status-badge ${status}">${status}</span></td>
                    <td><button class="action-btn view" onclick="window.open('creator.html?id=${u.id}')">View</button><button class="action-btn ${u.banned?'approve':'remove'}" onclick="toggleBan('${u.id}',${!!u.banned})">${u.banned?'Unban':'Ban'}</button></td>
                </tr>`;
            }).join('');
        }

        function renderReports() {
            const body = document.getElementById('reportsBody');
            if (!allReports.length) { body.innerHTML = '<tr><td colspan="6" class="empty-state">No reports</td></tr>'; return; }
            body.innerHTML = allReports.map(r => `<tr>
                <td>${r.contentType||'Video'}: ${(r.contentId||'').substring(0,8)}...</td>
                <td>${r.reason||'Not specified'}</td>
                <td>${r.reporterName||'Anonymous'}</td>
                <td>${formatDate(r.createdAt)}</td>
                <td><span class="status-badge ${r.status||'pending'}">${r.status||'pending'}</span></td>
                <td><button class="action-btn approve" onclick="resolveReport('${r.id}')">Resolve</button></td>
            </tr>`).join('');
        }

        window.removeVideo = async (id) => {
            if (!confirm('Remove this video?')) return;
            await deleteDoc(doc(db, 'videos', id));
            allVideos = allVideos.filter(v => v.id !== id);
            renderVideos('recentVideosBody', allVideos.slice(0,5));
            renderVideos('allVideosBody', allVideos, true);
            document.getElementById('totalVideos').textContent = allVideos.length;
        };

        window.toggleBan = async (id, isBanned) => {
            if (!confirm(isBanned ? 'Unban this user?' : 'Ban this user?')) return;
            await updateDoc(doc(db, 'users', id), { banned: !isBanned });
            const u = allUsers.find(x => x.id === id);
            if (u) u.banned = !isBanned;
            renderUsers();
        };

        window.resolveReport = async (id) => {
            await updateDoc(doc(db, 'reports', id), { status: 'resolved' });
            const r = allReports.find(x => x.id === id);
            if (r) r.status = 'resolved';
            renderReports();
            document.getElementById('pendingReports').textContent = allReports.filter(r => r.status === 'pending').length;
        };

        // Tab switching
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('section-' + tab.dataset.section).classList.add('active');
            });
        });

        // Search
        document.getElementById('videoSearch')?.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            const filtered = allVideos.filter(v => (v.title||'').toLowerCase().includes(q) || (v.creatorName||'').toLowerCase().includes(q));
            renderVideos('allVideosBody', filtered, true);
        });

        document.getElementById('userSearch')?.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u => (u.displayName||u.username||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
            const body = document.getElementById('allUsersBody');
            if (!filtered.length) { body.innerHTML = '<tr><td colspan="6" class="empty-state">No users found</td></tr>'; return; }
            // Re-render with filtered
            allUsers = filtered;
            renderUsers();
            allUsers = [...allUsers]; // Reset after render
        });
    </script>
</body>
</html>
