<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNCAGED | Notifications</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-primary:#0D0D0D;--bg-secondary:#1A1A1A;--bg-tertiary:#242424;--accent-gold:#F5A623;--text-primary:#FFFFFF;--text-secondary:#B3B3B3;--text-muted:#666666;--border-color:#2A2A2A}
        body{font-family:'DM Sans',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
        .header{position:fixed;top:0;left:0;right:0;height:60px;background:rgba(13,13,13,0.95);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:space-between;padding:0 30px;z-index:1000;border-bottom:1px solid var(--border-color)}
        .header-left{display:flex;align-items:center;gap:30px}
        .logo{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:3px;background:linear-gradient(135deg,var(--accent-gold),#D4880F);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-decoration:none}
        .nav-links{display:flex;gap:25px}
        .nav-links a{color:var(--text-secondary);text-decoration:none;font-size:14px}
        .profile-btn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-gold),#D4880F);display:flex;align-items:center;justify-content:center;font-weight:700;color:#000;cursor:pointer;font-size:14px;border:none;position:relative}
        .dropdown{position:absolute;top:calc(100% + 10px);right:0;background:var(--bg-secondary);border-radius:12px;padding:10px 0;min-width:200px;box-shadow:0 10px 40px rgba(0,0,0,0.5);display:none;border:1px solid var(--border-color)}
        .dropdown.show{display:block}
        .dropdown a{display:block;padding:12px 20px;color:var(--text-secondary);text-decoration:none;font-size:14px}
        .dropdown a:hover{background:var(--bg-tertiary);color:var(--text-primary)}
        .dropdown .divider{height:1px;background:var(--border-color);margin:8px 0}

        .main{max-width:800px;margin:0 auto;padding:80px 30px 40px}
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
        .page-title{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:2px}
        .mark-all{background:none;border:1px solid var(--border-color);color:var(--text-secondary);padding:8px 16px;border-radius:20px;cursor:pointer;font-size:13px}
        .mark-all:hover{background:var(--bg-secondary);color:var(--text-primary)}

        .tabs{display:flex;gap:5px;margin-bottom:25px;border-bottom:1px solid var(--border-color);padding-bottom:15px}
        .tab{padding:10px 20px;background:transparent;border:none;color:var(--text-secondary);cursor:pointer;font-size:14px;border-radius:8px}
        .tab:hover{background:var(--bg-tertiary)}
        .tab.active{background:var(--accent-gold);color:#000;font-weight:600}
        .tab .count{background:var(--bg-tertiary);padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px}
        .tab.active .count{background:rgba(0,0,0,0.2)}

        .notifications-list{display:flex;flex-direction:column;gap:10px}
        .notification{display:flex;gap:15px;background:var(--bg-secondary);border-radius:12px;padding:15px 20px;cursor:pointer;transition:background 0.2s}
        .notification:hover{background:var(--bg-tertiary)}
        .notification.unread{background:rgba(245,166,35,0.05);border-left:3px solid var(--accent-gold)}
        .notification.unread:hover{background:rgba(245,166,35,0.1)}
        .notif-icon{width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .notif-icon.subscriber{background:rgba(40,167,69,0.2);color:#28A745}
        .notif-icon.comment{background:rgba(0,123,255,0.2);color:#007BFF}
        .notif-icon.like{background:rgba(220,53,69,0.2);color:#DC3545}
        .notif-icon.system{background:rgba(108,117,125,0.2);color:#6C757D}
        .notif-icon.milestone{background:rgba(245,166,35,0.2);color:var(--accent-gold)}
        .notif-icon svg{width:22px;height:22px}
        .notif-content{flex:1;min-width:0}
        .notif-text{font-size:14px;line-height:1.5;margin-bottom:5px}
        .notif-text strong{color:var(--text-primary)}
        .notif-time{color:var(--text-muted);font-size:12px}
        .notif-thumb{width:60px;height:40px;border-radius:6px;background:var(--bg-tertiary);overflow:hidden;flex-shrink:0}
        .notif-thumb img{width:100%;height:100%;object-fit:cover}

        .empty-state{text-align:center;padding:80px 20px}
        .empty-state svg{width:80px;height:80px;color:var(--text-muted);margin-bottom:20px}
        .empty-state h2{font-size:20px;margin-bottom:10px}
        .empty-state p{color:var(--text-muted)}

        .loading{text-align:center;padding:60px}
        .loading-spinner{width:40px;height:40px;border:3px solid var(--border-color);border-top-color:var(--accent-gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
        @keyframes spin{to{transform:rotate(360deg)}}

        @media(max-width:768px){.main{padding:70px 15px 20px}.page-header{flex-direction:column;gap:15px;align-items:flex-start}.header{padding:0 15px}.nav-links{display:none}}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="logo">UNCAGED</a>
            <nav class="nav-links">
                <a href="browse.html">Browse</a>
                <a href="dashboard.html">Dashboard</a>
            </nav>
        </div>
        <button class="profile-btn" id="profileBtn">V
            <div class="dropdown" id="profileDropdown">
                <a href="dashboard.html">Dashboard</a>
                <a href="my-videos.html">My Videos</a>
                <a href="earnings.html">Earnings</a>
                <div class="divider"></div>
                <a href="notifications.html">Notifications</a>
                <a href="settings.html">Settings</a>
                <div class="divider"></div>
                <a href="#" id="logoutBtn">Log Out</a>
            </div>
        </button>
    </header>

    <main class="main">
        <div class="page-header">
            <h1 class="page-title">Notifications</h1>
            <button class="mark-all" id="markAllBtn">Mark all as read</button>
        </div>

        <div class="tabs">
            <button class="tab active" data-filter="all">All <span class="count" id="countAll">0</span></button>
            <button class="tab" data-filter="unread">Unread <span class="count" id="countUnread">0</span></button>
            <button class="tab" data-filter="subscriber">Subscribers</button>
            <button class="tab" data-filter="comment">Comments</button>
            <button class="tab" data-filter="like">Likes</button>
        </div>

        <div class="notifications-list" id="notificationsList">
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading notifications...
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyDNPN3jptNzbR8vWy5hnVCuLoIBK2AW_HQ",
            authDomain: "uncaged-85b49.firebaseapp.com",
            projectId: "uncaged-85b49",
            storageBucket: "uncaged-85b49.firebasestorage.app",
            messagingSenderId: "957750920887",
            appId: "1:957750920887:web:9af4d847dad76c876d2f32"
        });
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allNotifications = [];
        let currentFilter = 'all';

        const icons = {
            subscriber: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
            comment: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
            like: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>',
            system: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
            milestone: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>'
        };

        function timeAgo(ts) {
            if (!ts) return '';
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            const now = new Date();
            const mins = Math.floor((now - d) / 60000);
            if (mins < 1) return 'Just now';
            if (mins < 60) return mins + ' min ago';
            const hrs = Math.floor(mins / 60);
            if (hrs < 24) return hrs + ' hour' + (hrs > 1 ? 's' : '') + ' ago';
            const days = Math.floor(hrs / 24);
            if (days < 7) return days + ' day' + (days > 1 ? 's' : '') + ' ago';
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                location.href = 'login.html';
                return;
            }
            currentUser = user;
            document.getElementById('profileBtn').childNodes[0].textContent = (user.displayName || user.email)[0].toUpperCase();
            loadNotifications();
        });

        // Dropdown
        document.getElementById('profileBtn').onclick = (e) => {
            e.stopPropagation();
            document.getElementById('profileDropdown').classList.toggle('show');
        };
        document.onclick = () => document.getElementById('profileDropdown').classList.remove('show');
        document.querySelectorAll('.dropdown').forEach(d => d.onclick = e => e.stopPropagation());
        document.getElementById('logoutBtn').onclick = async (e) => {
            e.preventDefault();
            await signOut(auth);
            location.href = 'index.html';
        };

        // Load notifications
        async function loadNotifications() {
            const container = document.getElementById('notificationsList');
            
            try {
                const snap = await getDocs(
                    query(
                        collection(db, 'notifications'),
                        where('userId', '==', currentUser.uid),
                        orderBy('createdAt', 'desc'),
                        limit(50)
                    )
                );

                allNotifications = [];
                snap.forEach(d => allNotifications.push({ id: d.id, ...d.data() }));

                // If no real notifications, show demo data
                if (allNotifications.length === 0) {
                    allNotifications = generateDemoNotifications();
                }

                updateCounts();
                renderNotifications();
            } catch (e) {
                console.error(e);
                // Show demo notifications on error (likely missing index)
                allNotifications = generateDemoNotifications();
                updateCounts();
                renderNotifications();
            }
        }

        function generateDemoNotifications() {
            const now = new Date();
            return [
                { id: '1', type: 'subscriber', text: '<strong>Alex Johnson</strong> subscribed to your channel', read: false, createdAt: { toDate: () => new Date(now - 1000 * 60 * 5) } },
                { id: '2', type: 'comment', text: '<strong>Sarah M.</strong> commented on your video "Getting Started"', read: false, createdAt: { toDate: () => new Date(now - 1000 * 60 * 30) }, videoId: 'demo' },
                { id: '3', type: 'like', text: '<strong>Mike Chen</strong> and 12 others liked your video', read: true, createdAt: { toDate: () => new Date(now - 1000 * 60 * 60 * 2) }, videoId: 'demo' },
                { id: '4', type: 'milestone', text: 'Congratulations! Your video reached <strong>1,000 views</strong>', read: true, createdAt: { toDate: () => new Date(now - 1000 * 60 * 60 * 24) }, videoId: 'demo' },
                { id: '5', type: 'subscriber', text: '<strong>Emma Wilson</strong> subscribed to your channel', read: true, createdAt: { toDate: () => new Date(now - 1000 * 60 * 60 * 48) } },
                { id: '6', type: 'system', text: 'Your payout of <strong>$125.00</strong> has been processed', read: true, createdAt: { toDate: () => new Date(now - 1000 * 60 * 60 * 72) } },
                { id: '7', type: 'comment', text: '<strong>David K.</strong> replied to your comment', read: true, createdAt: { toDate: () => new Date(now - 1000 * 60 * 60 * 96) }, videoId: 'demo' },
            ];
        }

        function updateCounts() {
            document.getElementById('countAll').textContent = allNotifications.length;
            document.getElementById('countUnread').textContent = allNotifications.filter(n => !n.read).length;
        }

        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            let filtered = allNotifications;

            if (currentFilter === 'unread') {
                filtered = filtered.filter(n => !n.read);
            } else if (currentFilter !== 'all') {
                filtered = filtered.filter(n => n.type === currentFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                        <h2>No notifications</h2>
                        <p>${currentFilter === 'unread' ? 'You\'re all caught up!' : 'Nothing here yet'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(n => `
                <div class="notification ${n.read ? '' : 'unread'}" onclick="handleNotificationClick('${n.id}', '${n.videoId || ''}')">
                    <div class="notif-icon ${n.type}">${icons[n.type] || icons.system}</div>
                    <div class="notif-content">
                        <div class="notif-text">${n.text}</div>
                        <div class="notif-time">${timeAgo(n.createdAt)}</div>
                    </div>
                    ${n.videoId ? '<div class="notif-thumb"><img src="https://vz-fa698983-d99.b-cdn.net/' + n.videoId + '/thumbnail.jpg" onerror="this.parentElement.style.display=\'none\'"></div>' : ''}
                </div>
            `).join('');
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                renderNotifications();
            };
        });

        // Handle notification click
        window.handleNotificationClick = async (id, videoId) => {
            // Mark as read
            const notif = allNotifications.find(n => n.id === id);
            if (notif && !notif.read) {
                notif.read = true;
                try {
                    await updateDoc(doc(db, 'notifications', id), { read: true });
                } catch (e) {}
                updateCounts();
                renderNotifications();
            }

            // Navigate to video if applicable
            if (videoId && videoId !== 'demo') {
                location.href = 'watch.html?v=' + videoId;
            }
        };

        // Mark all as read
        document.getElementById('markAllBtn').onclick = async () => {
            const unread = allNotifications.filter(n => !n.read);
            if (unread.length === 0) return;

            unread.forEach(n => n.read = true);
            updateCounts();
            renderNotifications();

            try {
                const batch = writeBatch(db);
                unread.forEach(n => {
                    if (n.id && !n.id.startsWith('demo')) {
                        batch.update(doc(db, 'notifications', n.id), { read: true });
                    }
                });
                await batch.commit();
            } catch (e) {
                console.error(e);
            }
        };
    </script>
</body>
</html>
