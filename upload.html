<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNCAGED | Upload</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-primary:#0D0D0D;--bg-secondary:#1A1A1A;--bg-tertiary:#242424;--accent-gold:#F5A623;--accent-gold-dark:#D4880F;--text-primary:#FFFFFF;--text-secondary:#B3B3B3;--text-muted:#666666;--border-color:#2A2A2A}
        body{font-family:'DM Sans',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
        .header{position:fixed;top:0;left:0;right:0;height:60px;background:rgba(13,13,13,0.95);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:space-between;padding:0 30px;z-index:1000;border-bottom:1px solid var(--border-color)}
        .header-left{display:flex;align-items:center;gap:30px}
        .logo{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:3px;background:linear-gradient(135deg,var(--accent-gold),var(--accent-gold-dark));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-decoration:none}
        .nav-links{display:flex;gap:25px}
        .nav-links a{color:var(--text-secondary);text-decoration:none;font-size:14px}
        .nav-links a:hover{color:var(--text-primary)}
        .profile-btn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-gold),var(--accent-gold-dark));display:flex;align-items:center;justify-content:center;font-weight:700;color:#000;cursor:pointer;font-size:14px;border:none;position:relative}
        .dropdown{position:absolute;top:calc(100% + 10px);right:0;background:var(--bg-secondary);border-radius:12px;padding:10px 0;min-width:200px;box-shadow:0 10px 40px rgba(0,0,0,0.5);display:none;z-index:1001;border:1px solid var(--border-color)}
        .dropdown.show{display:block}
        .dropdown a{display:block;padding:12px 20px;color:var(--text-secondary);text-decoration:none;font-size:14px}
        .dropdown a:hover{background:var(--bg-tertiary);color:var(--text-primary)}
        .dropdown .divider{height:1px;background:var(--border-color);margin:8px 0}

        .main{max-width:800px;margin:0 auto;padding:100px 30px 40px}
        .page-title{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:2px;margin-bottom:30px}
        .upload-box{background:var(--bg-secondary);border-radius:16px;padding:40px}
        .dropzone{border:2px dashed var(--border-color);border-radius:12px;padding:60px;text-align:center;cursor:pointer;transition:all 0.3s;margin-bottom:30px}
        .dropzone:hover,.dropzone.dragover{border-color:var(--accent-gold);background:rgba(245,166,35,0.05)}
        .dropzone svg{width:60px;height:60px;color:var(--text-muted);margin-bottom:15px}
        .dropzone h3{font-size:18px;margin-bottom:10px}
        .dropzone p{color:var(--text-muted);font-size:14px}
        .dropzone input{display:none}
        .progress-bar{height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden;margin-bottom:10px;display:none}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-gold),var(--accent-gold-dark));width:0%;transition:width 0.3s}
        .progress-text{color:var(--text-muted);font-size:13px;margin-bottom:20px;display:none}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;font-size:14px;color:var(--text-secondary)}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:10px;color:var(--text-primary);font-size:14px;font-family:inherit}
        .form-group input:focus,.form-group textarea:focus{outline:none;border-color:var(--accent-gold)}
        .form-group textarea{min-height:120px;resize:vertical}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        .btn-publish{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent-gold),var(--accent-gold-dark));border:none;border-radius:10px;color:#000;font-weight:700;font-size:16px;cursor:pointer;margin-top:10px}
        .btn-publish:disabled{opacity:0.6;cursor:not-allowed}
        .error-msg{background:rgba(220,53,69,0.1);border:1px solid #DC3545;color:#DC3545;padding:12px;border-radius:8px;margin-bottom:20px;display:none}
        .success-msg{background:rgba(40,167,69,0.1);border:1px solid #28A745;color:#28A745;padding:12px;border-radius:8px;margin-bottom:20px;display:none}

        @media(max-width:768px){.main{padding:80px 15px 20px}.form-row{grid-template-columns:1fr}.header{padding:0 15px}}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="logo">UNCAGED</a>
            <nav class="nav-links">
                <a href="browse.html">Browse</a>
                <a href="dashboard.html">Dashboard</a>
            </nav>
        </div>
        <button class="profile-btn" id="profileBtn">V
            <div class="dropdown" id="profileDropdown">
                <a href="dashboard.html">Dashboard</a>
                <a href="my-videos.html">My Videos</a>
                <a href="earnings.html">Earnings</a>
                <div class="divider"></div>
                <a href="stripe-connect.html">Get Paid</a>
                <a href="settings.html">Settings</a>
                <div class="divider"></div>
                <a href="#" id="logoutBtn">Log Out</a>
            </div>
        </button>
    </header>

    <main class="main">
        <h1 class="page-title">Upload Video</h1>
        <div class="upload-box">
            <div class="error-msg" id="errorMsg"></div>
            <div class="success-msg" id="successMsg"></div>
            
            <div class="dropzone" id="dropzone">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <h3>Drop your video here</h3>
                <p>or click to browse (MP4, MOV, max 5GB)</p>
                <input type="file" id="fileInput" accept="video/*">
            </div>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Uploading...</div>

            <form id="videoForm">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="title" required placeholder="Give your video a title">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" placeholder="Tell viewers about your video"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="category">
                            <option value="">Select category</option>
                            <option>Gaming</option>
                            <option>Music</option>
                            <option>Entertainment</option>
                            <option>Sports</option>
                            <option>Education</option>
                            <option>Lifestyle</option>
                            <option>Tech</option>
                            <option>Travel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Visibility</label>
                        <select id="visibility">
                            <option value="public">Public</option>
                            <option value="private">Private</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="tags" placeholder="gaming, walkthrough, tutorial">
                </div>
                <button type="submit" class="btn-publish" id="publishBtn" disabled>Publish Video</button>
            </form>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyDNPN3jptNzbR8vWy5hnVCuLoIBK2AW_HQ",
            authDomain: "uncaged-85b49.firebaseapp.com",
            projectId: "uncaged-85b49",
            storageBucket: "uncaged-85b49.firebasestorage.app",
            messagingSenderId: "957750920887",
            appId: "1:957750920887:web:9af4d847dad76c876d2f32"
        });
        const auth = getAuth(app);
        const db = getFirestore(app);
        const BUNNY_KEY = '2c87ab86-6ef1-4dbf-8fcf4c40cf06-b823-4f9b';
        const BUNNY_LIB = '588548';

        let currentUser = null;
        let uploadedVideoId = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                location.href = 'login.html';
                return;
            }
            currentUser = user;
            document.getElementById('profileBtn').childNodes[0].textContent = (user.displayName || user.email)[0].toUpperCase();
        });

        // Dropdown
        document.getElementById('profileBtn').onclick = (e) => {
            e.stopPropagation();
            document.getElementById('profileDropdown').classList.toggle('show');
        };
        document.onclick = () => document.getElementById('profileDropdown').classList.remove('show');
        document.querySelectorAll('.dropdown').forEach(d => d.onclick = e => e.stopPropagation());

        document.getElementById('logoutBtn').onclick = async (e) => {
            e.preventDefault();
            await signOut(auth);
            location.href = 'index.html';
        };

        // Dropzone
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');

        dropzone.onclick = () => fileInput.click();
        dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add('dragover'); };
        dropzone.ondragleave = () => dropzone.classList.remove('dragover');
        dropzone.ondrop = (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        };
        fileInput.onchange = (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        };

        async function handleFile(file) {
            if (!file.type.startsWith('video/')) {
                showError('Please select a video file');
                return;
            }
            if (file.size > 5 * 1024 * 1024 * 1024) {
                showError('File too large (max 5GB)');
                return;
            }

            dropzone.innerHTML = '<h3>' + file.name + '</h3><p>' + (file.size / 1024 / 1024).toFixed(1) + ' MB</p>';
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('progressText').style.display = 'block';

            try {
                // Create video in Bunny
                const createRes = await fetch('https://video.bunnycdn.com/library/' + BUNNY_LIB + '/videos', {
                    method: 'POST',
                    headers: {
                        'AccessKey': BUNNY_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: file.name })
                });
                const vid = await createRes.json();
                uploadedVideoId = vid.guid;

                // Upload to Bunny
                const xhr = new XMLHttpRequest();
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round(e.loaded / e.total * 100);
                        document.getElementById('progressFill').style.width = pct + '%';
                        document.getElementById('progressText').textContent = 'Uploading... ' + pct + '%';
                    }
                };
                xhr.onload = () => {
                    if (xhr.status === 200) {
                        document.getElementById('progressText').textContent = 'Upload complete! Fill in details below.';
                        document.getElementById('publishBtn').disabled = false;
                    } else {
                        showError('Upload failed');
                    }
                };
                xhr.onerror = () => showError('Upload failed');
                xhr.open('PUT', 'https://video.bunnycdn.com/library/' + BUNNY_LIB + '/videos/' + uploadedVideoId);
                xhr.setRequestHeader('AccessKey', BUNNY_KEY);
                xhr.send(file);
            } catch (e) {
                showError(e.message);
            }
        }

        // Publish
        document.getElementById('videoForm').onsubmit = async (e) => {
            e.preventDefault();
            
            if (!uploadedVideoId) {
                showError('Please upload a video first');
                return;
            }

            const btn = document.getElementById('publishBtn');
            btn.disabled = true;
            btn.textContent = 'Publishing...';

            try {
                const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);
                
                await addDoc(collection(db, 'videos'), {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    category: document.getElementById('category').value,
                    visibility: document.getElementById('visibility').value,
                    tags,
                    bunnyVideoId: uploadedVideoId,
                    creatorId: currentUser.uid,
                    creatorName: currentUser.displayName || currentUser.email.split('@')[0],
                    views: 0,
                    likes: 0,
                    createdAt: serverTimestamp()
                });

                document.getElementById('successMsg').textContent = 'Video published successfully!';
                document.getElementById('successMsg').style.display = 'block';
                setTimeout(() => location.href = 'my-videos.html', 1500);
            } catch (e) {
                showError(e.message);
                btn.disabled = false;
                btn.textContent = 'Publish Video';
            }
        };

        function showError(msg) {
            document.getElementById('errorMsg').textContent = msg;
            document.getElementById('errorMsg').style.display = 'block';
        }
    </script>
</body>
</html>
