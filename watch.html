<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch - UNCAGED</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background-color: #0D0D0D; color: #FFFFFF; min-height: 100vh; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: #1A1A1A; border-bottom: 1px solid #2A2A2A; position: sticky; top: 0; z-index: 100; }
        .logo { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; background: linear-gradient(135deg, #F5A623, #D4880F); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-decoration: none; }
        .nav-links { display: flex; align-items: center; gap: 1.5rem; }
        .nav-links a { color: #B3B3B3; text-decoration: none; font-weight: 500; transition: color 0.3s; }
        .nav-links a:hover { color: #F5A623; }
        .search-bar { display: flex; align-items: center; background: #242424; border-radius: 24px; padding: 0.5rem 1rem; border: 1px solid #2A2A2A; }
        .search-bar input { background: none; border: none; color: #FFFFFF; padding: 0.3rem; width: 200px; font-family: 'DM Sans', sans-serif; }
        .search-bar input:focus { outline: none; }
        .search-bar button { background: none; border: none; color: #B3B3B3; cursor: pointer; }
        .profile-dropdown { position: relative; }
        .profile-btn { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #F5A623, #D4880F); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #0D0D0D; }
        .dropdown-menu { position: absolute; top: 50px; right: 0; background: #1A1A1A; border: 1px solid #2A2A2A; border-radius: 8px; min-width: 200px; display: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); }
        .dropdown-menu.show { display: block; }
        .dropdown-menu a { display: block; padding: 0.8rem 1rem; color: #B3B3B3; text-decoration: none; transition: background 0.3s; }
        .dropdown-menu a:hover { background: #242424; color: #F5A623; }
        .main-content { display: grid; grid-template-columns: 1fr 400px; gap: 2rem; max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .video-section { width: 100%; }
        .video-container { position: relative; width: 100%; aspect-ratio: 16/9; background: #000000; border-radius: 12px; overflow: hidden; }
        .video-container iframe { width: 100%; height: 100%; border: none; }
        .video-info { margin-top: 1rem; }
        .video-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
        .video-meta { display: flex; align-items: center; gap: 1rem; color: #B3B3B3; font-size: 0.9rem; margin-bottom: 1rem; }
        .video-actions { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; padding: 1rem 0; border-top: 1px solid #2A2A2A; border-bottom: 1px solid #2A2A2A; }
        .action-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1rem; background: #242424; border: 1px solid #2A2A2A; border-radius: 20px; color: #FFFFFF; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; }
        .action-btn:hover { border-color: #F5A623; color: #F5A623; }
        .action-btn.active { background: linear-gradient(135deg, #F5A623, #D4880F); color: #0D0D0D; border-color: transparent; }
        .action-btn.watch-later.saved { background: #4CAF50; border-color: #4CAF50; color: #FFFFFF; }
        .report-btn { margin-left: auto; color: #F44336; border-color: #F44336; }
        .report-btn:hover { background: #F44336; color: #FFFFFF; }
        .creator-section { display: flex; align-items: center; gap: 1rem; padding: 1rem 0; }
        .creator-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #F5A623, #D4880F); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.2rem; color: #0D0D0D; }
        .creator-info { flex: 1; }
        .creator-name { font-weight: 600; color: #FFFFFF; text-decoration: none; }
        .creator-name:hover { color: #F5A623; }
        .creator-subs { color: #666666; font-size: 0.9rem; }
        .subscribe-btn { padding: 0.6rem 1.5rem; background: linear-gradient(135deg, #F5A623, #D4880F); color: #0D0D0D; border: none; border-radius: 20px; font-family: 'DM Sans', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .subscribe-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(245, 166, 35, 0.4); }
        .subscribe-btn.subscribed { background: #242424; color: #B3B3B3; border: 1px solid #2A2A2A; }
        .description-section { background: #1A1A1A; border-radius: 12px; padding: 1rem; margin-top: 1rem; }
        .description-text { color: #B3B3B3; line-height: 1.6; white-space: pre-wrap; }
        .description-text.collapsed { max-height: 60px; overflow: hidden; }
        .show-more-btn { background: none; border: none; color: #F5A623; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 500; margin-top: 0.5rem; }
        .comments-section { margin-top: 2rem; }
        .comments-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .comments-count { font-weight: 600; font-size: 1.1rem; }
        .comment-form { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background: #242424; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .comment-input-wrapper { flex: 1; }
        .comment-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid #2A2A2A; color: #FFFFFF; font-family: 'DM Sans', sans-serif; font-size: 1rem; padding: 0.5rem 0; transition: border-color 0.3s; }
        .comment-input:focus { outline: none; border-color: #F5A623; }
        .comment-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.5rem; display: none; }
        .comment-actions.show { display: flex; }
        .comment-btn { padding: 0.5rem 1rem; border-radius: 20px; font-family: 'DM Sans', sans-serif; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .cancel-btn { background: transparent; border: none; color: #B3B3B3; }
        .submit-comment-btn { background: linear-gradient(135deg, #F5A623, #D4880F); border: none; color: #0D0D0D; }
        .submit-comment-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .comments-list { display: flex; flex-direction: column; gap: 1.5rem; }
        .comment-item { display: flex; gap: 1rem; }
        .comment-content { flex: 1; }
        .comment-author { font-weight: 600; margin-bottom: 0.25rem; }
        .comment-author span { color: #666666; font-weight: 400; font-size: 0.85rem; margin-left: 0.5rem; }
        .comment-text { color: #B3B3B3; line-height: 1.5; }
        .sidebar { display: flex; flex-direction: column; gap: 1rem; }
        .sidebar-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; margin-bottom: 0.5rem; }
        .recommended-video { display: flex; gap: 0.75rem; text-decoration: none; transition: opacity 0.3s; }
        .recommended-video:hover { opacity: 0.8; }
        .recommended-thumb { width: 168px; height: 94px; border-radius: 8px; object-fit: cover; background: #242424; flex-shrink: 0; }
        .recommended-info { flex: 1; }
        .recommended-title { color: #FFFFFF; font-weight: 500; font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 0.25rem; }
        .recommended-creator { color: #666666; font-size: 0.8rem; }
        .recommended-meta { color: #666666; font-size: 0.8rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.show { display: flex; }
        .modal { background: #1A1A1A; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; border: 1px solid #2A2A2A; }
        .modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; margin-bottom: 1rem; }
        .report-options { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
        .report-option { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #242424; border-radius: 8px; cursor: pointer; transition: background 0.3s; }
        .report-option:hover { background: #2A2A2A; }
        .report-option input { accent-color: #F5A623; }
        .report-textarea { width: 100%; padding: 0.75rem; background: #242424; border: 1px solid #2A2A2A; border-radius: 8px; color: #FFFFFF; font-family: 'DM Sans', sans-serif; resize: vertical; min-height: 80px; margin-bottom: 1rem; }
        .report-textarea:focus { outline: none; border-color: #F5A623; }
        .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; }
        .modal-btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .modal-cancel { background: #242424; border: none; color: #FFFFFF; }
        .modal-submit { background: #F44336; border: none; color: #FFFFFF; }
        .modal-submit:hover { background: #D32F2F; }
        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: #1A1A1A; border: 1px solid #2A2A2A; padding: 1rem 1.5rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; transition: transform 0.3s; z-index: 1001; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: #4CAF50; }
        .toast.error { border-color: #F44336; }
        .loading { text-align: center; padding: 4rem; color: #B3B3B3; }
        .spinner { width: 40px; height: 40px; border: 3px solid #2A2A2A; border-top-color: #F5A623; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } .sidebar { order: 2; } .search-bar { display: none; } }
        @media (max-width: 768px) { .navbar { padding: 1rem; } .main-content { padding: 1rem; } .video-actions { flex-wrap: wrap; } .report-btn { margin-left: 0; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">UNCAGED</a>
        <div class="nav-links">
            <div class="search-bar">
                <input type="text" placeholder="Search videos..." id="searchInput">
                <button id="searchBtn">üîç</button>
            </div>
            <a href="browse.html">Browse</a>
            <div class="profile-dropdown">
                <button class="profile-btn" id="profileBtn">?</button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="my-videos.html">My Videos</a>
                    <a href="history.html">Watch History</a>
                    <a href="playlists.html">Playlists</a>
                    <a href="settings.html">Settings</a>
                    <a href="#" id="logoutBtn">Log Out</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="video-section">
            <div class="loading" id="loadingState"><div class="spinner"></div><p>Loading video...</p></div>
            <div class="video-container" id="videoContainer" style="display: none;"><iframe id="videoPlayer" allowfullscreen></iframe></div>
            <div class="video-info" id="videoInfo" style="display: none;">
                <h1 class="video-title" id="videoTitle"></h1>
                <div class="video-meta"><span id="viewCount">0 views</span><span id="uploadDate"></span></div>
                <div class="video-actions">
                    <button class="action-btn" id="likeBtn"><span>üëç</span><span id="likeCount">0</span></button>
                    <button class="action-btn watch-later" id="watchLaterBtn"><span>üïê</span><span>Watch Later</span></button>
                    <button class="action-btn" id="shareBtn"><span>üîó</span><span>Share</span></button>
                    <button class="action-btn report-btn" id="reportBtn"><span>üö©</span><span>Report</span></button>
                </div>
                <div class="creator-section">
                    <div class="creator-avatar" id="creatorAvatar">?</div>
                    <div class="creator-info"><a href="#" class="creator-name" id="creatorName"></a><div class="creator-subs" id="creatorSubs">0 subscribers</div></div>
                    <button class="subscribe-btn" id="subscribeBtn">Subscribe</button>
                </div>
                <div class="description-section">
                    <p class="description-text collapsed" id="descriptionText"></p>
                    <button class="show-more-btn" id="showMoreBtn">Show more</button>
                </div>
                <div class="comments-section">
                    <div class="comments-header"><span class="comments-count" id="commentsCount">0 Comments</span></div>
                    <div class="comment-form" id="commentForm" style="display: none;">
                        <div class="comment-avatar" id="userAvatar">?</div>
                        <div class="comment-input-wrapper">
                            <input type="text" class="comment-input" id="commentInput" placeholder="Add a comment...">
                            <div class="comment-actions" id="commentActions">
                                <button class="comment-btn cancel-btn" id="cancelComment">Cancel</button>
                                <button class="comment-btn submit-comment-btn" id="submitComment" disabled>Comment</button>
                            </div>
                        </div>
                    </div>
                    <div class="comments-list" id="commentsList"></div>
                </div>
            </div>
        </div>
        <aside class="sidebar" id="sidebar" style="display: none;">
            <h2 class="sidebar-title">Recommended</h2>
            <div id="recommendedVideos"></div>
        </aside>
    </main>

    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <h2 class="modal-title">Report Video</h2>
            <div class="report-options">
                <label class="report-option"><input type="radio" name="reportType" value="spam"><span>Spam or misleading</span></label>
                <label class="report-option"><input type="radio" name="reportType" value="hateful"><span>Hateful or abusive content</span></label>
                <label class="report-option"><input type="radio" name="reportType" value="harmful"><span>Harmful or dangerous acts</span></label>
                <label class="report-option"><input type="radio" name="reportType" value="sexual"><span>Sexual content</span></label>
                <label class="report-option"><input type="radio" name="reportType" value="violence"><span>Violent or graphic content</span></label>
                <label class="report-option"><input type="radio" name="reportType" value="copyright"><span>Copyright infringement</span></label>
                <label class="report-option"><input type="radio" name="reportType" value="other"><span>Other</span></label>
            </div>
            <textarea class="report-textarea" id="reportReason" placeholder="Additional details (optional)..."></textarea>
            <div class="modal-actions">
                <button class="modal-btn modal-cancel" id="cancelReport">Cancel</button>
                <button class="modal-btn modal-submit" id="submitReport">Submit Report</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span id="toastMessage"></span></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, collection, query, where, orderBy, limit, addDoc, updateDoc, deleteDoc, increment, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDNPN3jptNzbR8vWy5hnVCuLoIBK2AW_HQ", authDomain: "uncaged-85b49.firebaseapp.com", projectId: "uncaged-85b49", storageBucket: "uncaged-85b49.firebasestorage.app", messagingSenderId: "957750920887", appId: "1:957750920887:web:9af4d847dad76c876d2f32" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentVideo = null, videoId = null, isLiked = false, isSubscribed = false, isWatchLater = false;
        const urlParams = new URLSearchParams(window.location.search);
        videoId = urlParams.get('v');
        if (!videoId) window.location.href = 'browse.html';

        const $ = id => document.getElementById(id);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('profileBtn').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
                $('userAvatar').textContent = $('profileBtn').textContent;
                $('commentForm').style.display = 'flex';
            }
            loadVideo();
        });

        $('profileBtn').addEventListener('click', () => $('dropdownMenu').classList.toggle('show'));
        document.addEventListener('click', (e) => { if (!e.target.closest('.profile-dropdown')) $('dropdownMenu').classList.remove('show'); });
        $('logoutBtn').addEventListener('click', async (e) => { e.preventDefault(); await signOut(auth); window.location.href = 'index.html'; });

        async function loadVideo() {
            try {
                const videoDoc = await getDoc(doc(db, 'videos', videoId));
                if (!videoDoc.exists()) { showToast('Video not found', 'error'); setTimeout(() => window.location.href = 'browse.html', 2000); return; }
                currentVideo = { id: videoDoc.id, ...videoDoc.data() };
                await updateDoc(doc(db, 'videos', videoId), { views: increment(1) });
                currentVideo.views = (currentVideo.views || 0) + 1;
                if (currentUser) { await saveToWatchHistory(); await checkWatchLaterStatus(); }
                displayVideo();
                if (currentUser) await checkUserInteractions();
                await loadComments();
                await loadRecommended();
            } catch (error) { console.error('Error loading video:', error); showToast('Error loading video', 'error'); }
        }

        async function saveToWatchHistory() {
            if (!currentUser || !currentVideo) return;
            try {
                await setDoc(doc(db, 'watchHistory', `${currentUser.uid}_${videoId}`), {
                    userId: currentUser.uid, videoId: videoId, videoTitle: currentVideo.title, creatorName: currentVideo.creatorName,
                    creatorId: currentVideo.creatorId, thumbnail: currentVideo.thumbnail || `https://vz-fa698983-d99.b-cdn.net/${currentVideo.bunnyVideoId}/thumbnail.jpg`,
                    bunnyVideoId: currentVideo.bunnyVideoId, views: currentVideo.views, progress: 0, watchedAt: serverTimestamp()
                }, { merge: true });
            } catch (error) { console.error('Error saving to watch history:', error); }
        }

        async function checkWatchLaterStatus() {
            if (!currentUser) return;
            try {
                const watchLaterDoc = await getDoc(doc(db, 'watchLater', `${currentUser.uid}_${videoId}`));
                if (watchLaterDoc.exists()) { isWatchLater = true; $('watchLaterBtn').classList.add('saved'); $('watchLaterBtn').innerHTML = '<span>‚úì</span><span>Saved</span>'; }
            } catch (error) { console.error('Error checking watch later:', error); }
        }

        async function toggleWatchLater() {
            if (!currentUser) { showToast('Please sign in to save videos', 'error'); return; }
            try {
                const ref = doc(db, 'watchLater', `${currentUser.uid}_${videoId}`);
                if (isWatchLater) {
                    await deleteDoc(ref); isWatchLater = false; $('watchLaterBtn').classList.remove('saved');
                    $('watchLaterBtn').innerHTML = '<span>üïê</span><span>Watch Later</span>'; showToast('Removed from Watch Later', 'success');
                } else {
                    await setDoc(ref, { userId: currentUser.uid, videoId: videoId, videoTitle: currentVideo.title, creatorName: currentVideo.creatorName,
                        creatorId: currentVideo.creatorId, thumbnail: currentVideo.thumbnail || `https://vz-fa698983-d99.b-cdn.net/${currentVideo.bunnyVideoId}/thumbnail.jpg`,
                        bunnyVideoId: currentVideo.bunnyVideoId, addedAt: serverTimestamp() });
                    isWatchLater = true; $('watchLaterBtn').classList.add('saved'); $('watchLaterBtn').innerHTML = '<span>‚úì</span><span>Saved</span>';
                    showToast('Added to Watch Later', 'success');
                }
            } catch (error) { console.error('Error toggling watch later:', error); showToast('Error updating Watch Later', 'error'); }
        }

        function displayVideo() {
            $('loadingState').style.display = 'none'; $('videoContainer').style.display = 'block'; $('videoInfo').style.display = 'block'; $('sidebar').style.display = 'flex';
            $('videoPlayer').src = `https://iframe.mediadelivery.net/embed/588548/${currentVideo.bunnyVideoId}?autoplay=false&preload=true`;
            $('videoTitle').textContent = currentVideo.title || 'Untitled';
            document.title = `${currentVideo.title || 'Untitled'} - UNCAGED`;
            $('viewCount').textContent = `${(currentVideo.views || 0).toLocaleString()} views`;
            if (currentVideo.createdAt) { const date = currentVideo.createdAt.toDate(); $('uploadDate').textContent = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }); }
            $('likeCount').textContent = (currentVideo.likes || 0).toLocaleString();
            $('creatorAvatar').textContent = currentVideo.creatorName ? currentVideo.creatorName.charAt(0).toUpperCase() : '?';
            $('creatorName').textContent = currentVideo.creatorName || 'Unknown Creator';
            $('creatorName').href = `creator.html?id=${currentVideo.creatorId}`;
            $('descriptionText').textContent = currentVideo.description || 'No description';
            loadCreatorInfo();
        }

        async function loadCreatorInfo() {
            try { const creatorDoc = await getDoc(doc(db, 'users', currentVideo.creatorId)); if (creatorDoc.exists()) $('creatorSubs').textContent = `${(creatorDoc.data().subscribers || 0).toLocaleString()} subscribers`; } catch (error) { console.error('Error loading creator info:', error); }
        }

        async function checkUserInteractions() {
            try {
                const likeDoc = await getDoc(doc(db, 'likes', `${currentUser.uid}_${videoId}`));
                if (likeDoc.exists()) { isLiked = true; $('likeBtn').classList.add('active'); }
                const subDoc = await getDoc(doc(db, 'subscriptions', `${currentUser.uid}_${currentVideo.creatorId}`));
                if (subDoc.exists()) { isSubscribed = true; $('subscribeBtn').textContent = 'Subscribed'; $('subscribeBtn').classList.add('subscribed'); }
            } catch (error) { console.error('Error checking interactions:', error); }
        }

        $('likeBtn').addEventListener('click', async () => {
            if (!currentUser) { showToast('Please sign in to like videos', 'error'); return; }
            try {
                const likeRef = doc(db, 'likes', `${currentUser.uid}_${videoId}`);
                if (isLiked) {
                    await deleteDoc(likeRef); await updateDoc(doc(db, 'videos', videoId), { likes: increment(-1) }); isLiked = false;
                    $('likeBtn').classList.remove('active'); $('likeCount').textContent = Math.max(0, parseInt($('likeCount').textContent.replace(/,/g, '')) - 1).toLocaleString();
                } else {
                    await setDoc(likeRef, { userId: currentUser.uid, videoId: videoId, createdAt: serverTimestamp() });
                    await updateDoc(doc(db, 'videos', videoId), { likes: increment(1) });
                    if (currentVideo.creatorId !== currentUser.uid) await addDoc(collection(db, 'notifications'), { userId: currentVideo.creatorId, type: 'like', text: `${currentUser.displayName || 'Someone'} liked your video "${currentVideo.title}"`, videoId: videoId, read: false, createdAt: serverTimestamp() });
                    isLiked = true; $('likeBtn').classList.add('active'); $('likeCount').textContent = (parseInt($('likeCount').textContent.replace(/,/g, '')) + 1).toLocaleString();
                }
            } catch (error) { console.error('Error toggling like:', error); showToast('Error updating like', 'error'); }
        });

        $('watchLaterBtn').addEventListener('click', toggleWatchLater);

        $('subscribeBtn').addEventListener('click', async () => {
            if (!currentUser) { showToast('Please sign in to subscribe', 'error'); return; }
            if (currentVideo.creatorId === currentUser.uid) { showToast("You can't subscribe to yourself", 'error'); return; }
            try {
                const subRef = doc(db, 'subscriptions', `${currentUser.uid}_${currentVideo.creatorId}`);
                if (isSubscribed) {
                    await deleteDoc(subRef); await updateDoc(doc(db, 'users', currentVideo.creatorId), { subscribers: increment(-1) });
                    isSubscribed = false; $('subscribeBtn').textContent = 'Subscribe'; $('subscribeBtn').classList.remove('subscribed'); showToast('Unsubscribed', 'success');
                } else {
                    await setDoc(subRef, { subscriberId: currentUser.uid, creatorId: currentVideo.creatorId, createdAt: serverTimestamp() });
                    await updateDoc(doc(db, 'users', currentVideo.creatorId), { subscribers: increment(1) });
                    await addDoc(collection(db, 'notifications'), { userId: currentVideo.creatorId, type: 'subscriber', text: `${currentUser.displayName || 'Someone'} subscribed to your channel`, read: false, createdAt: serverTimestamp() });
                    isSubscribed = true; $('subscribeBtn').textContent = 'Subscribed'; $('subscribeBtn').classList.add('subscribed'); showToast('Subscribed!', 'success');
                }
            } catch (error) { console.error('Error toggling subscription:', error); showToast('Error updating subscription', 'error'); }
        });

        $('shareBtn').addEventListener('click', async () => {
            const url = window.location.href;
            if (navigator.share) { try { await navigator.share({ title: currentVideo.title, url: url }); } catch (error) { if (error.name !== 'AbortError') copyToClipboard(url); } } else { copyToClipboard(url); }
        });

        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => showToast('Link copied to clipboard!', 'success')).catch(() => showToast('Failed to copy link', 'error')); }

        $('showMoreBtn').addEventListener('click', () => { $('descriptionText').classList.toggle('collapsed'); $('showMoreBtn').textContent = $('descriptionText').classList.contains('collapsed') ? 'Show more' : 'Show less'; });

        $('commentInput').addEventListener('focus', () => $('commentActions').classList.add('show'));
        $('commentInput').addEventListener('input', () => $('submitComment').disabled = !$('commentInput').value.trim());
        $('cancelComment').addEventListener('click', () => { $('commentInput').value = ''; $('commentActions').classList.remove('show'); $('submitComment').disabled = true; });

        $('submitComment').addEventListener('click', async () => {
            const text = $('commentInput').value.trim();
            if (!text || !currentUser) return;
            try {
                $('submitComment').disabled = true;
                await addDoc(collection(db, 'comments'), { videoId: videoId, authorId: currentUser.uid, authorName: currentUser.displayName || currentUser.email.split('@')[0], text: text, createdAt: serverTimestamp() });
                if (currentVideo.creatorId !== currentUser.uid) await addDoc(collection(db, 'notifications'), { userId: currentVideo.creatorId, type: 'comment', text: `${currentUser.displayName || 'Someone'} commented on your video "${currentVideo.title}"`, videoId: videoId, read: false, createdAt: serverTimestamp() });
                $('commentInput').value = ''; $('commentActions').classList.remove('show'); showToast('Comment posted!', 'success'); await loadComments();
            } catch (error) { console.error('Error posting comment:', error); showToast('Error posting comment', 'error'); $('submitComment').disabled = false; }
        });

        async function loadComments() {
            try {
                const q = query(collection(db, 'comments'), where('videoId', '==', videoId), orderBy('createdAt', 'desc'), limit(50));
                const snapshot = await getDocs(q);
                const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                $('commentsCount').textContent = `${comments.length} Comment${comments.length !== 1 ? 's' : ''}`;
                $('commentsList').innerHTML = comments.map(comment => {
                    const date = comment.createdAt?.toDate();
                    const timeAgo = date ? getTimeAgo(date) : '';
                    return `<div class="comment-item"><div class="comment-avatar">${comment.authorName?.charAt(0).toUpperCase() || '?'}</div><div class="comment-content"><div class="comment-author">${comment.authorName || 'Anonymous'}<span>${timeAgo}</span></div><p class="comment-text">${escapeHtml(comment.text)}</p></div></div>`;
                }).join('');
            } catch (error) { console.error('Error loading comments:', error); }
        }

        async function loadRecommended() {
            try {
                const q = query(collection(db, 'videos'), where('visibility', '==', 'public'), where('status', '==', 'active'), orderBy('createdAt', 'desc'), limit(10));
                const snapshot = await getDocs(q);
                const videos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(v => v.id !== videoId);
                $('recommendedVideos').innerHTML = videos.slice(0, 8).map(video => {
                    const thumbnail = video.thumbnail || `https://vz-fa698983-d99.b-cdn.net/${video.bunnyVideoId}/thumbnail.jpg`;
                    return `<a href="watch.html?v=${video.id}" class="recommended-video"><img src="${thumbnail}" alt="${video.title}" class="recommended-thumb" onerror="this.src='https://via.placeholder.com/168x94/242424/666666?text=No+Thumb'"><div class="recommended-info"><div class="recommended-title">${video.title || 'Untitled'}</div><div class="recommended-creator">${video.creatorName || 'Unknown'}</div><div class="recommended-meta">${(video.views || 0).toLocaleString()} views</div></div></a>`;
                }).join('');
            } catch (error) { console.error('Error loading recommended:', error); }
        }

        $('reportBtn').addEventListener('click', () => { if (!currentUser) { showToast('Please sign in to report videos', 'error'); return; } $('reportModal').classList.add('show'); });
        $('cancelReport').addEventListener('click', () => $('reportModal').classList.remove('show'));
        $('submitReport').addEventListener('click', async () => {
            const selectedType = document.querySelector('input[name="reportType"]:checked');
            if (!selectedType) { showToast('Please select a reason', 'error'); return; }
            try {
                await addDoc(collection(db, 'reports'), { videoId: videoId, videoTitle: currentVideo.title, creatorId: currentVideo.creatorId, type: selectedType.value, reason: $('reportReason').value, reporterId: currentUser.uid, reporterName: currentUser.displayName || currentUser.email, status: 'pending', createdAt: serverTimestamp() });
                $('reportModal').classList.remove('show'); $('reportReason').value = ''; document.querySelectorAll('input[name="reportType"]').forEach(r => r.checked = false); showToast('Report submitted', 'success');
            } catch (error) { console.error('Error submitting report:', error); showToast('Error submitting report', 'error'); }
        });
        $('reportModal').addEventListener('click', (e) => { if (e.target === $('reportModal')) $('reportModal').classList.remove('show'); });

        $('searchBtn').addEventListener('click', () => { const query = $('searchInput').value.trim(); if (query) window.location.href = `search.html?q=${encodeURIComponent(query)}`; });
        $('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { const query = e.target.value.trim(); if (query) window.location.href = `search.html?q=${encodeURIComponent(query)}`; } });

        function showToast(message, type = 'success') { $('toastMessage').textContent = message; $('toast').className = `toast ${type} show`; setTimeout(() => $('toast').classList.remove('show'), 3000); }
        function getTimeAgo(date) { const seconds = Math.floor((new Date() - date) / 1000); const intervals = { year: 31536000, month: 2592000, week: 604800, day: 86400, hour: 3600, minute: 60 }; for (const [unit, secondsInUnit] of Object.entries(intervals)) { const interval = Math.floor(seconds / secondsInUnit); if (interval >= 1) return `${interval} ${unit}${interval !== 1 ? 's' : ''} ago`; } return 'Just now'; }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    </script>
</body>
</html>
