<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNCAGED | Connect with Stripe</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #0D0D0D; color: #FFFFFF; min-height: 100vh; }
        .header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(13,13,13,0.95); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 1000; border-bottom: 1px solid #1A1A1A; }
        .logo { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 3px; background: linear-gradient(135deg, #F5A623, #D4880F); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; }
        .container { max-width: 600px; margin: 0 auto; padding: 100px 20px 40px; text-align: center; }
        .title { font-family: 'Bebas Neue', sans-serif; font-size: 42px; margin-bottom: 15px; }
        .desc { color: #888; font-size: 16px; margin-bottom: 40px; }
        .connect-btn { display: inline-block; padding: 16px 40px; background: #635BFF; color: #FFF; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; text-decoration: none; }
        .connect-btn:hover { background: #5851DB; }
        .connect-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .error-box { background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #DC3545; display: none; }
        .success-box { background: rgba(40,167,69,0.1); border: 1px solid rgba(40,167,69,0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #28A745; display: none; }
        .back-link { display: inline-block; margin-top: 30px; color: #888; text-decoration: none; }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">UNCAGED</a>
    </header>
    <div class="container">
        <h1 class="title">üí≥ Get Paid with Stripe</h1>
        <p class="desc">Connect your bank account to receive your earnings. You keep 85% of everything.</p>
        <div id="successBox" class="success-box">‚úÖ Stripe already connected!</div>
        <div id="errorBox" class="error-box"></div>
        <button class="connect-btn" id="connectBtn" disabled>Loading...</button>
        <br>
        <a href="dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDNPN3jptNzbR8vWy5hnVCuLoIBK2AW_HQ",
            authDomain: "uncaged-85b49.firebaseapp.com",
            projectId: "uncaged-85b49",
            storageBucket: "uncaged-85b49.firebasestorage.app",
            messagingSenderId: "957750920887",
            appId: "1:957750920887:web:9af4d847dad76c876d2f32"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        const btn = document.getElementById('connectBtn');
        const errorBox = document.getElementById('errorBox');
        const successBox = document.getElementById('successBox');

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = user;
            
            // Check if already connected
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists() && userDoc.data().stripeConnectId) {
                successBox.style.display = 'block';
                btn.textContent = 'Update Stripe Account';
            } else {
                btn.textContent = 'Connect with Stripe';
            }
            btn.disabled = false;
        });

        btn.addEventListener('click', async () => {
            if (!currentUser) {
                errorBox.textContent = 'Please log in first';
                errorBox.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Connecting...';
            errorBox.style.display = 'none';

            try {
                const response = await fetch('/api/create-connect-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.uid,
                        email: currentUser.email
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to connect');
                }

                if (data.success && data.onboardingUrl) {
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        stripeConnectId: data.accountId
                    });
                    window.location.href = data.onboardingUrl;
                } else {
                    throw new Error('Invalid response');
                }

            } catch (error) {
                errorBox.textContent = 'Error: ' + error.message;
                errorBox.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Try Again';
            }
        });
    </script>
</body>
</html>
