<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch History - UNCAGED</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:#0D0D0D;color:#FFF;min-height:100vh}
        .navbar{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:#1A1A1A;border-bottom:1px solid #2A2A2A;position:sticky;top:0;z-index:100}
        .logo{font-family:'Bebas Neue',sans-serif;font-size:2rem;background:linear-gradient(135deg,#F5A623,#D4880F);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-decoration:none}
        .nav-links{display:flex;align-items:center;gap:1.5rem}
        .nav-links a{color:#B3B3B3;text-decoration:none;font-weight:500}.nav-links a:hover{color:#F5A623}
        .profile-dropdown{position:relative}
        .profile-btn{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#F5A623,#D4880F);border:none;cursor:pointer;font-weight:600;color:#0D0D0D}
        .dropdown-menu{position:absolute;top:50px;right:0;background:#1A1A1A;border:1px solid #2A2A2A;border-radius:8px;min-width:200px;display:none;z-index:200}
        .dropdown-menu.show{display:block}
        .dropdown-menu a{display:block;padding:.8rem 1rem;color:#B3B3B3;text-decoration:none}
        .dropdown-menu a:hover{background:#242424;color:#F5A623}
        
        .main-content{max-width:1000px;margin:0 auto;padding:2rem}
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}
        .page-title{font-family:'Bebas Neue',sans-serif;font-size:2.5rem}
        .clear-btn{padding:0.5rem 1rem;background:transparent;border:1px solid #F44336;border-radius:8px;color:#F44336;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.2s}
        .clear-btn:hover{background:#F44336;color:#FFF}
        
        .tabs{display:flex;gap:1rem;margin-bottom:2rem}
        .tab{padding:0.6rem 1.25rem;background:#1A1A1A;border:1px solid #2A2A2A;border-radius:20px;color:#B3B3B3;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.2s}
        .tab:hover,.tab.active{border-color:#F5A623;color:#F5A623}
        
        .history-list{display:flex;flex-direction:column;gap:0.5rem}
        .date-group{margin-bottom:2rem}
        .date-header{color:#666;font-size:0.9rem;margin-bottom:1rem;padding-bottom:0.5rem;border-bottom:1px solid #2A2A2A}
        
        .history-item{display:flex;gap:1rem;padding:0.75rem;background:#1A1A1A;border-radius:12px;border:1px solid #2A2A2A;transition:all 0.2s}
        .history-item:hover{border-color:#333}
        .history-thumb{width:180px;height:100px;border-radius:8px;object-fit:cover;background:#242424;flex-shrink:0}
        .history-info{flex:1;min-width:0}
        .history-title{font-weight:600;margin-bottom:0.25rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .history-title a{color:#FFF;text-decoration:none}
        .history-title a:hover{color:#F5A623}
        .history-creator{color:#B3B3B3;font-size:0.9rem;margin-bottom:0.25rem}
        .history-creator a{color:#B3B3B3;text-decoration:none}
        .history-creator a:hover{color:#F5A623}
        .history-meta{color:#666;font-size:0.85rem}
        .history-actions{display:flex;align-items:flex-start}
        .remove-btn{padding:0.5rem;background:none;border:none;color:#666;cursor:pointer;font-size:1.2rem;transition:color 0.2s}
        .remove-btn:hover{color:#F44336}
        
        .loading{text-align:center;padding:4rem}
        .spinner{width:40px;height:40px;border:3px solid #2A2A2A;border-top-color:#F5A623;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        .empty-state{text-align:center;padding:4rem}
        .empty-state-icon{font-size:4rem;margin-bottom:1rem}
        .empty-state-title{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;margin-bottom:0.5rem}
        .empty-state-text{color:#666}
        
        .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(100px);background:#1A1A1A;border:1px solid #2A2A2A;padding:1rem 1.5rem;border-radius:8px;transition:transform .3s;z-index:1001}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .toast.success{border-color:#4CAF50}
        
        @media(max-width:768px){
            .navbar{padding:1rem}
            .main-content{padding:1rem}
            .history-item{flex-direction:column}
            .history-thumb{width:100%;height:auto;aspect-ratio:16/9}
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">UNCAGED</a>
        <div class="nav-links">
            <a href="browse.html">Browse</a>
            <div class="profile-dropdown">
                <button class="profile-btn" id="profileBtn">?</button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="my-videos.html">My Videos</a>
                    <a href="notifications.html">Notifications</a>
                    <a href="settings.html">Settings</a>
                    <a href="#" id="logoutBtn">Log Out</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">History</h1>
            <button class="clear-btn" id="clearBtn">Clear All</button>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="history">Watch History</button>
            <button class="tab" data-tab="watchlater">Watch Later</button>
        </div>

        <div class="loading" id="loadingState"><div class="spinner"></div><p>Loading...</p></div>
        <div class="history-list" id="historyList" style="display:none"></div>
        <div class="empty-state" id="emptyState" style="display:none">
            <div class="empty-state-icon">ðŸ“º</div>
            <h2 class="empty-state-title">No watch history</h2>
            <p class="empty-state-text">Videos you watch will appear here</p>
        </div>
    </main>

    <div class="toast" id="toast"><span id="toastMessage"></span></div>

    <script type="module">
        import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import{getFirestore,collection,getDocs,query,where,orderBy,deleteDoc,doc,writeBatch}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig={apiKey:"AIzaSyDNPN3jptNzbR8vWy5hnVCuLoIBK2AW_HQ",authDomain:"uncaged-85b49.firebaseapp.com",projectId:"uncaged-85b49",storageBucket:"uncaged-85b49.firebasestorage.app",messagingSenderId:"957750920887",appId:"1:957750920887:web:9af4d847dad76c876d2f32"};
        const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);
        
        const $=id=>document.getElementById(id);
        let currentUser=null,historyItems=[],watchLaterItems=[],currentTab='history';

        onAuthStateChanged(auth,async user=>{
            if(!user){window.location.href='login.html';return;}
            currentUser=user;
            $('profileBtn').textContent=(user.displayName||user.email)[0].toUpperCase();
            await loadData();
        });

        $('profileBtn').onclick=()=>$('dropdownMenu').classList.toggle('show');
        document.onclick=e=>{if(!e.target.closest('.profile-dropdown'))$('dropdownMenu').classList.remove('show');};
        $('logoutBtn').onclick=async e=>{e.preventDefault();await signOut(auth);window.location.href='index.html';};

        document.querySelectorAll('.tab').forEach(tab=>{
            tab.onclick=()=>{
                document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
                tab.classList.add('active');
                currentTab=tab.dataset.tab;
                displayItems();
            };
        });

        $('clearBtn').onclick=async()=>{
            if(!confirm('Clear all?'))return;
            try{
                const batch=writeBatch(db);
                const items=currentTab==='history'?historyItems:watchLaterItems;
                const collName=currentTab==='history'?'watchHistory':'watchLater';
                items.forEach(item=>batch.delete(doc(db,collName,item.id)));
                await batch.commit();
                if(currentTab==='history')historyItems=[];else watchLaterItems=[];
                displayItems();
                showToast('Cleared!');
            }catch(e){console.error(e);}
        };

        async function loadData(){
            try{
                const hq=query(collection(db,'watchHistory'),where('userId','==',currentUser.uid),orderBy('watchedAt','desc'));
                const hsnap=await getDocs(hq);
                historyItems=hsnap.docs.map(d=>({id:d.id,...d.data()}));

                const wq=query(collection(db,'watchLater'),where('userId','==',currentUser.uid),orderBy('addedAt','desc'));
                const wsnap=await getDocs(wq);
                watchLaterItems=wsnap.docs.map(d=>({id:d.id,...d.data()}));

                displayItems();
            }catch(err){
                console.error(err);
                $('loadingState').style.display='none';
                $('emptyState').style.display='block';
            }
        }

        function displayItems(){
            const items=currentTab==='history'?historyItems:watchLaterItems;
            const timeField=currentTab==='history'?'watchedAt':'addedAt';
            
            $('loadingState').style.display='none';

            if(items.length===0){
                $('historyList').style.display='none';
                $('emptyState').style.display='block';
                $('emptyState').querySelector('.empty-state-title').textContent=currentTab==='history'?'No watch history':'Watch Later is empty';
                $('emptyState').querySelector('.empty-state-text').textContent=currentTab==='history'?'Videos you watch will appear here':'Save videos to watch later';
                return;
            }

            $('emptyState').style.display='none';
            $('historyList').style.display='flex';

            const groups={};
            items.forEach(item=>{
                const date=item[timeField]?.toDate();
                if(!date)return;
                const key=formatDateGroup(date);
                if(!groups[key])groups[key]=[];
                groups[key].push(item);
            });

            $('historyList').innerHTML=Object.entries(groups).map(([date,items])=>`
                <div class="date-group">
                    <div class="date-header">${date}</div>
                    ${items.map(item=>`
                        <div class="history-item">
                            <a href="watch.html?v=${item.videoId}">
                                <img src="${item.thumbnail||'https://via.placeholder.com/180x100/242424/666?text=Video'}" class="history-thumb" onerror="this.src='https://via.placeholder.com/180x100/242424/666?text=Video'">
                            </a>
                            <div class="history-info">
                                <h3 class="history-title"><a href="watch.html?v=${item.videoId}">${item.videoTitle||'Untitled'}</a></h3>
                                <p class="history-creator">${item.creatorName||'Unknown'}</p>
                                <p class="history-meta">${getTimeAgo(item[timeField]?.toDate())}</p>
                            </div>
                            <div class="history-actions">
                                <button class="remove-btn" data-id="${item.id}" title="Remove">âœ•</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');

            document.querySelectorAll('.remove-btn').forEach(btn=>{
                btn.onclick=async e=>{
                    e.stopPropagation();
                    const id=btn.dataset.id;
                    const collName=currentTab==='history'?'watchHistory':'watchLater';
                    try{
                        await deleteDoc(doc(db,collName,id));
                        if(currentTab==='history')historyItems=historyItems.filter(i=>i.id!==id);
                        else watchLaterItems=watchLaterItems.filter(i=>i.id!==id);
                        displayItems();
                        showToast('Removed');
                    }catch(e){console.error(e);}
                };
            });
        }

        function formatDateGroup(date){
            const now=new Date();
            const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
            const yesterday=new Date(today.getTime()-86400000);
            const dateOnly=new Date(date.getFullYear(),date.getMonth(),date.getDate());
            
            if(dateOnly.getTime()===today.getTime())return'Today';
            if(dateOnly.getTime()===yesterday.getTime())return'Yesterday';
            if(dateOnly.getTime()>today.getTime()-7*86400000)return'This Week';
            return date.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
        }

        function getTimeAgo(date){
            if(!date)return'';
            const s=Math.floor((new Date()-date)/1000);
            const i={year:31536000,month:2592000,week:604800,day:86400,hour:3600,minute:60};
            for(const[u,v]of Object.entries(i)){const n=Math.floor(s/v);if(n>=1)return`${n} ${u}${n!==1?'s':''} ago`;}
            return'Just now';
        }

        function showToast(msg){$('toastMessage').textContent=msg;$('toast').className='toast success show';setTimeout(()=>$('toast').classList.remove('show'),3000);}
    </script>
</body>
</html>
