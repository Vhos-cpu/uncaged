<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earnings - UNCAGED</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:#0D0D0D;color:#FFF;min-height:100vh}
        .navbar{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:#1A1A1A;border-bottom:1px solid #2A2A2A;position:sticky;top:0;z-index:100}
        .logo{font-family:'Bebas Neue',sans-serif;font-size:2rem;background:linear-gradient(135deg,#F5A623,#D4880F);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-decoration:none}
        .nav-links{display:flex;align-items:center;gap:1.5rem}
        .nav-links a{color:#B3B3B3;text-decoration:none;font-weight:500}.nav-links a:hover{color:#F5A623}
        .profile-dropdown{position:relative}
        .profile-btn{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#F5A623,#D4880F);border:none;cursor:pointer;font-weight:600;color:#0D0D0D}
        .dropdown-menu{position:absolute;top:50px;right:0;background:#1A1A1A;border:1px solid #2A2A2A;border-radius:8px;min-width:200px;display:none;z-index:200}
        .dropdown-menu.show{display:block}
        .dropdown-menu a{display:block;padding:.8rem 1rem;color:#B3B3B3;text-decoration:none}
        .dropdown-menu a:hover{background:#242424;color:#F5A623}
        
        .main-content{max-width:1200px;margin:0 auto;padding:2rem}
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}
        .page-title{font-family:'Bebas Neue',sans-serif;font-size:2.5rem}
        
        .earnings-overview{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem}
        .stat-card{background:#1A1A1A;border-radius:16px;padding:1.5rem;border:1px solid #2A2A2A}
        .stat-card.highlight{background:linear-gradient(135deg,rgba(245,166,35,0.1),rgba(212,136,15,0.1));border-color:#F5A623}
        .stat-label{color:#666;font-size:0.9rem;margin-bottom:0.5rem}
        .stat-value{font-size:2rem;font-weight:600}
        .stat-value.gold{color:#F5A623}
        .stat-change{font-size:0.85rem;margin-top:0.5rem}
        .stat-change.positive{color:#4CAF50}
        .stat-change.negative{color:#F44336}
        
        .revenue-split{margin-bottom:2rem}
        .split-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .split-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem}
        .split-badge{background:linear-gradient(135deg,#F5A623,#D4880F);color:#0D0D0D;padding:0.25rem 0.75rem;border-radius:20px;font-size:0.85rem;font-weight:600}
        .split-bar{height:40px;background:#242424;border-radius:8px;overflow:hidden;display:flex}
        .split-segment{display:flex;align-items:center;justify-content:center;font-weight:600;font-size:0.85rem}
        .split-creator{background:linear-gradient(135deg,#F5A623,#D4880F);color:#0D0D0D}
        .split-platform{background:#333;color:#B3B3B3}
        
        .section{margin-bottom:2rem}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .section-title{font-family:'Bebas Neue',sans-serif;font-size:1.5rem}
        
        .chart-container{background:#1A1A1A;border-radius:16px;padding:1.5rem;border:1px solid #2A2A2A;margin-bottom:2rem}
        .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
        .chart-tabs{display:flex;gap:0.5rem}
        .chart-tab{padding:0.5rem 1rem;background:#242424;border:1px solid #2A2A2A;border-radius:20px;color:#B3B3B3;cursor:pointer;font-size:0.85rem}
        .chart-tab:hover,.chart-tab.active{border-color:#F5A623;color:#F5A623}
        .chart{height:200px;display:flex;align-items:flex-end;gap:0.5rem;padding-top:1rem}
        .chart-bar{flex:1;background:linear-gradient(to top,#F5A623,#D4880F);border-radius:4px 4px 0 0;min-height:10px;position:relative;transition:height 0.3s}
        .chart-bar:hover{opacity:0.8}
        .chart-bar::after{content:attr(data-value);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);color:#B3B3B3;font-size:0.75rem;padding:0.25rem;white-space:nowrap;opacity:0;transition:opacity 0.2s}
        .chart-bar:hover::after{opacity:1}
        .chart-labels{display:flex;gap:0.5rem;margin-top:0.5rem}
        .chart-label{flex:1;text-align:center;color:#666;font-size:0.75rem}
        
        .payout-section{background:#1A1A1A;border-radius:16px;padding:1.5rem;border:1px solid #2A2A2A}
        .payout-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .payout-btn{padding:0.75rem 1.5rem;background:linear-gradient(135deg,#F5A623,#D4880F);border:none;border-radius:8px;color:#0D0D0D;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;transition:all 0.2s}
        .payout-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(245,166,35,0.4)}
        .payout-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        
        .payout-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem;padding:1rem;background:#242424;border-radius:8px}
        .payout-info-item{text-align:center}
        .payout-info-label{color:#666;font-size:0.85rem}
        .payout-info-value{font-size:1.25rem;font-weight:600;color:#F5A623}
        
        .transactions-list{max-height:400px;overflow-y:auto}
        .transaction-item{display:flex;align-items:center;gap:1rem;padding:1rem;border-bottom:1px solid #2A2A2A}
        .transaction-item:last-child{border-bottom:none}
        .transaction-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .transaction-icon.tip{background:rgba(245,166,35,0.2)}
        .transaction-icon.payout{background:rgba(76,175,80,0.2)}
        .transaction-icon.revenue{background:rgba(33,150,243,0.2)}
        .transaction-info{flex:1}
        .transaction-title{font-weight:500;margin-bottom:0.25rem}
        .transaction-date{color:#666;font-size:0.85rem}
        .transaction-amount{font-weight:600}
        .transaction-amount.positive{color:#4CAF50}
        .transaction-amount.negative{color:#F44336}
        
        .empty-state{text-align:center;padding:3rem;color:#666}
        
        .loading{text-align:center;padding:4rem}
        .spinner{width:40px;height:40px;border:3px solid #2A2A2A;border-top-color:#F5A623;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(100px);background:#1A1A1A;border:1px solid #2A2A2A;padding:1rem 1.5rem;border-radius:8px;transition:transform .3s;z-index:1001}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .toast.success{border-color:#4CAF50}
        .toast.error{border-color:#F44336}
        
        @media(max-width:768px){
            .navbar{padding:1rem}
            .main-content{padding:1rem}
            .stat-value{font-size:1.5rem}
            .chart{height:150px}
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">UNCAGED</a>
        <div class="nav-links">
            <a href="dashboard.html">Dashboard</a>
            <a href="my-videos.html">My Videos</a>
            <div class="profile-dropdown">
                <button class="profile-btn" id="profileBtn">?</button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="my-videos.html">My Videos</a>
                    <a href="upload.html">Upload</a>
                    <a href="settings.html">Settings</a>
                    <a href="#" id="logoutBtn">Log Out</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">ðŸ’° Earnings</h1>
        </div>

        <div class="loading" id="loadingState"><div class="spinner"></div><p>Loading earnings...</p></div>

        <div id="contentArea" style="display:none">
            <div class="earnings-overview">
                <div class="stat-card highlight">
                    <div class="stat-label">Available Balance</div>
                    <div class="stat-value gold" id="availableBalance">$0.00</div>
                    <div class="stat-change positive" id="balanceChange">Ready for payout</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Earnings (All Time)</div>
                    <div class="stat-value" id="totalEarnings">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Month</div>
                    <div class="stat-value" id="monthEarnings">$0.00</div>
                    <div class="stat-change" id="monthChange"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Tips Received</div>
                    <div class="stat-value" id="totalTips">0</div>
                </div>
            </div>

            <div class="revenue-split">
                <div class="split-header">
                    <h2 class="split-title">Your Revenue Split</h2>
                    <span class="split-badge">85% Creator / 15% Platform</span>
                </div>
                <div class="split-bar">
                    <div class="split-segment split-creator" style="width:85%">You keep 85%</div>
                    <div class="split-segment split-platform" style="width:15%">15%</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="section-title">Earnings Over Time</h2>
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-range="7">7 Days</button>
                        <button class="chart-tab" data-range="30">30 Days</button>
                        <button class="chart-tab" data-range="90">90 Days</button>
                    </div>
                </div>
                <div class="chart" id="earningsChart"></div>
                <div class="chart-labels" id="chartLabels"></div>
            </div>

            <div class="payout-section">
                <div class="payout-header">
                    <h2 class="section-title">Payouts</h2>
                    <button class="payout-btn" id="requestPayoutBtn">Request Payout</button>
                </div>
                
                <div class="payout-info">
                    <div class="payout-info-item">
                        <div class="payout-info-label">Minimum Payout</div>
                        <div class="payout-info-value">$10.00</div>
                    </div>
                    <div class="payout-info-item">
                        <div class="payout-info-label">Payout Method</div>
                        <div class="payout-info-value" id="payoutMethod">Not Set</div>
                    </div>
                    <div class="payout-info-item">
                        <div class="payout-info-label">Next Payout</div>
                        <div class="payout-info-value" id="nextPayout">--</div>
                    </div>
                </div>

                <h3 style="margin-bottom:1rem;color:#B3B3B3">Transaction History</h3>
                <div class="transactions-list" id="transactionsList">
                    <div class="empty-state">No transactions yet</div>
                </div>
            </div>
        </div>
    </main>

    <div class="toast" id="toast"><span id="toastMessage"></span></div>

    <script type="module">
        import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import{getFirestore,doc,getDoc,getDocs,collection,query,where,orderBy,limit}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig={apiKey:"AIzaSyDNPN3jptNzbR8vWy5hnVCuLoIBK2AW_HQ",authDomain:"uncaged-85b49.firebaseapp.com",projectId:"uncaged-85b49",storageBucket:"uncaged-85b49.firebasestorage.app",messagingSenderId:"957750920887",appId:"1:957750920887:web:9af4d847dad76c876d2f32"};
        const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);
        
        const $=id=>document.getElementById(id);
        let currentUser=null,userData=null,tips=[],currentRange=7;

        onAuthStateChanged(auth,async user=>{
            if(!user){window.location.href='login.html';return;}
            currentUser=user;
            $('profileBtn').textContent=(user.displayName||user.email)[0].toUpperCase();
            await loadEarnings();
        });

        $('profileBtn').onclick=()=>$('dropdownMenu').classList.toggle('show');
        document.onclick=e=>{if(!e.target.closest('.profile-dropdown'))$('dropdownMenu').classList.remove('show');};
        $('logoutBtn').onclick=async e=>{e.preventDefault();await signOut(auth);window.location.href='index.html';};

        document.querySelectorAll('.chart-tab').forEach(tab=>{
            tab.onclick=()=>{
                document.querySelectorAll('.chart-tab').forEach(t=>t.classList.remove('active'));
                tab.classList.add('active');
                currentRange=parseInt(tab.dataset.range);
                renderChart();
            };
        });

        async function loadEarnings(){
            try{
                // Get user data
                const userDoc=await getDoc(doc(db,'users',currentUser.uid));
                if(userDoc.exists())userData=userDoc.data();

                // Get tips received
                const tipsQuery=query(collection(db,'tips'),where('toUserId','==',currentUser.uid),orderBy('createdAt','desc'));
                const tipsSnap=await getDocs(tipsQuery);
                tips=tipsSnap.docs.map(d=>({id:d.id,...d.data()}));

                displayEarnings();
            }catch(err){
                console.error(err);
                $('loadingState').style.display='none';
                showToast('Error loading earnings','error');
            }
        }

        function displayEarnings(){
            $('loadingState').style.display='none';
            $('contentArea').style.display='block';

            const totalEarnings=userData?.totalEarnings||0;
            const totalTipsCount=userData?.totalTips||tips.length;
            
            // Calculate available balance (total - paid out)
            const paidOut=userData?.paidOut||0;
            const available=totalEarnings-paidOut;

            $('availableBalance').textContent=`$${available.toFixed(2)}`;
            $('totalEarnings').textContent=`$${totalEarnings.toFixed(2)}`;
            $('totalTips').textContent=totalTipsCount.toLocaleString();

            // This month's earnings
            const now=new Date();
            const monthStart=new Date(now.getFullYear(),now.getMonth(),1);
            const monthTips=tips.filter(t=>t.createdAt?.toDate()>=monthStart);
            const monthEarnings=monthTips.reduce((sum,t)=>sum+(t.creatorAmount||0),0);
            $('monthEarnings').textContent=`$${monthEarnings.toFixed(2)}`;

            // Check Stripe connection
            if(userData?.stripeAccountId){
                $('payoutMethod').textContent='Stripe Connected';
                $('payoutMethod').style.color='#4CAF50';
            }else{
                $('payoutMethod').innerHTML='<a href="stripe-connect.html" style="color:#F5A623">Connect Stripe</a>';
            }

            // Payout button
            $('requestPayoutBtn').disabled=available<10||!userData?.stripeAccountId;
            $('requestPayoutBtn').onclick=()=>{
                if(available<10)showToast('Minimum payout is $10','error');
                else if(!userData?.stripeAccountId)showToast('Please connect Stripe first','error');
                else showToast('Payout request submitted!','success');
            };

            renderChart();
            renderTransactions();
        }

        function renderChart(){
            const chart=$('earningsChart');
            const labels=$('chartLabels');
            
            // Group earnings by day
            const now=new Date();
            const days=[];
            for(let i=currentRange-1;i>=0;i--){
                const date=new Date(now);
                date.setDate(date.getDate()-i);
                date.setHours(0,0,0,0);
                days.push({date,amount:0});
            }

            tips.forEach(tip=>{
                const tipDate=tip.createdAt?.toDate();
                if(!tipDate)return;
                tipDate.setHours(0,0,0,0);
                const day=days.find(d=>d.date.getTime()===tipDate.getTime());
                if(day)day.amount+=(tip.creatorAmount||0);
            });

            const maxAmount=Math.max(...days.map(d=>d.amount),1);

            chart.innerHTML=days.map(d=>{
                const height=Math.max(10,(d.amount/maxAmount)*180);
                return`<div class="chart-bar" style="height:${height}px" data-value="$${d.amount.toFixed(2)}"></div>`;
            }).join('');

            labels.innerHTML=days.map((d,i)=>{
                if(currentRange<=7)return`<span class="chart-label">${d.date.toLocaleDateString('en-US',{weekday:'short'})}</span>`;
                if(i%Math.ceil(currentRange/7)===0)return`<span class="chart-label">${d.date.getMonth()+1}/${d.date.getDate()}</span>`;
                return`<span class="chart-label"></span>`;
            }).join('');
        }

        function renderTransactions(){
            if(tips.length===0){
                $('transactionsList').innerHTML='<div class="empty-state">No transactions yet. Start creating content to earn tips!</div>';
                return;
            }

            $('transactionsList').innerHTML=tips.slice(0,20).map(t=>`
                <div class="transaction-item">
                    <div class="transaction-icon tip">ðŸ’°</div>
                    <div class="transaction-info">
                        <div class="transaction-title">Tip from ${t.fromUserName||'Anonymous'}</div>
                        <div class="transaction-date">${formatDate(t.createdAt?.toDate())}</div>
                    </div>
                    <div class="transaction-amount positive">+$${(t.creatorAmount||0).toFixed(2)}</div>
                </div>
            `).join('');
        }

        function formatDate(date){
            if(!date)return'';
            return date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});
        }

        function showToast(msg,type='success'){
            $('toastMessage').textContent=msg;
            $('toast').className=`toast ${type} show`;
            setTimeout(()=>$('toast').classList.remove('show'),3000);
        }
    </script>
</body>
</html>
